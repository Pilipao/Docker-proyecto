version: '3.8'

services:
  # =========================================================
  # BASE DE DATOS PRIMARY (ESCRITURA)
  # =========================================================
  db-primary:
    image: postgres:16-alpine
    container_name: research_db_primary
    restart: always
    environment:
      POSTGRES_USER: ${DB_PRIMARY_USER:-postgres_user}
      POSTGRES_PASSWORD: ${DB_PRIMARY_PASSWORD:-postgres_password_secure_2024}
      POSTGRES_DB: ${DB_PRIMARY_NAME:-synthetic_data_db}
      POSTGRES_REPLICATION_USER: ${POSTGRES_REPLICATION_USER:-replicator}
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD:-replicator_password_secure_2024}
      POSTGRES_INITDB_ARGS: "-c wal_level=replica -c max_wal_senders=3 -c max_replication_slots=3"
    ports:
      - "${DB_PRIMARY_PORT:-5432}:5432"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./scripts/postgres-primary-init.sh:/docker-entrypoint-initdb.d/01-replication-setup.sh:ro
      - ./scripts/configure-pg-hba.sh:/docker-entrypoint-initdb.d/02-configure-pg-hba.sh:ro
      - postgres_primary_data:/var/lib/postgresql/data
      - ./logs/primary:/var/lib/postgresql/data/pg_log
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_PRIMARY_USER:-postgres_user} -d ${DB_PRIMARY_NAME:-synthetic_data_db}"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}
    networks:
      - research_network
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
      -c log_statement=all
      -c log_destination='stderr'
      -c logging_collector=on
      -c log_directory='pg_log'
      -c log_filename='postgresql-%Y-%m-%d_%H%M%S.log'
      -c log_rotation_age=1d
      -c log_rotation_size=100MB
      -c log_min_duration_statement=0
      -c log_checkpoints=on
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on
      -c log_temp_files=0
      -c log_autovacuum_min_duration=0
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

  # =========================================================
  # BASE DE DATOS REPLICA (LECTURA)
  # =========================================================
  db-replica:
    image: postgres:16-alpine
    container_name: research_db_replica
    restart: always
    environment:
      POSTGRES_USER: ${DB_REPLICA_USER:-postgres_user}
      POSTGRES_PASSWORD: ${DB_REPLICA_PASSWORD:-postgres_password_secure_2024}
      POSTGRES_DB: ${DB_REPLICA_NAME:-synthetic_data_db}
      POSTGRES_REPLICATION_USER: ${POSTGRES_REPLICATION_USER:-replicator}
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD:-replicator_password_secure_2024}
      POSTGRES_MASTER_HOST: db-primary
      POSTGRES_MASTER_PORT: 5432
      POSTGRES_MASTER_REPLICATION_SLOT: ${POSTGRES_MASTER_REPLICATION_SLOT:-replica_slot}
    ports:
      - "${DB_REPLICA_PORT:-5433}:5432"
    volumes:
      - ./scripts/docker-entrypoint-replica.sh:/usr/local/bin/docker-entrypoint-replica.sh:ro
      - postgres_replica_data:/var/lib/postgresql/data
      - ./logs/replica:/var/lib/postgresql/data/pg_log
    entrypoint: ["/bin/bash", "/usr/local/bin/docker-entrypoint-replica.sh"]
    command: >
      postgres
      -c hot_standby=on
      -c log_statement=all
      -c log_destination='stderr'
      -c logging_collector=on
      -c log_directory='pg_log'
      -c log_filename='postgresql-%Y-%m-%d_%H%M%S.log'
      -c log_rotation_age=1d
      -c log_rotation_size=100MB
      -c log_min_duration_statement=0
      -c log_checkpoints=on
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on
      -c log_temp_files=0
      -c log_autovacuum_min_duration=0
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_REPLICA_USER:-postgres_user} -d ${DB_REPLICA_NAME:-synthetic_data_db}"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}
      start_period: 60s
    networks:
      - research_network
    depends_on:
      db-primary:
        condition: service_healthy

  # =========================================================
  # SERVICIO DE API BACKEND (FastAPI)
  # =========================================================
  api:
    build: .
    container_name: research_api
    restart: always
    environment:
      # Configuración Primary (Escritura)
      DB_PRIMARY_HOST: ${DB_PRIMARY_HOST:-db-primary}
      DB_PRIMARY_PORT: ${DB_PRIMARY_PORT:-5432}
      DB_PRIMARY_NAME: ${DB_PRIMARY_NAME:-synthetic_data_db}
      DB_PRIMARY_USER: ${DB_PRIMARY_USER:-postgres_user}
      DB_PRIMARY_PASSWORD: ${DB_PRIMARY_PASSWORD:-postgres_password_secure_2024}
      DB_PRIMARY_URL: ${DB_PRIMARY_URL:-postgresql://postgres_user:postgres_password_secure_2024@db-primary:5432/synthetic_data_db}
      
      # Configuración Replica (Lectura)
      DB_REPLICA_HOST: ${DB_REPLICA_HOST:-db-replica}
      DB_REPLICA_PORT: ${DB_REPLICA_PORT:-5432}
      DB_REPLICA_NAME: ${DB_REPLICA_NAME:-synthetic_data_db}
      DB_REPLICA_USER: ${DB_REPLICA_USER:-postgres_user}
      DB_REPLICA_PASSWORD: ${DB_REPLICA_PASSWORD:-postgres_password_secure_2024}
      DB_REPLICA_URL: ${DB_REPLICA_URL:-postgresql://postgres_user:postgres_password_secure_2024@db-replica:5432/synthetic_data_db}
      
      # Configuración API
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      db-primary:
        condition: service_healthy
      db-replica:
        condition: service_healthy
    networks:
      - research_network
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health').read()\" || exit 1"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}
      start_period: 30s

  # =========================================================
  # SERVICIO DE FRONTEND (Nginx)
  # =========================================================
  frontend:
    image: nginx:alpine
    container_name: research_frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-80}:80"
    volumes:
      - ./index.html:/usr/share/nginx/html/index.html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      api:
        condition: service_healthy
    networks:
      - research_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/ || exit 1"]
      interval: ${HEALTHCHECK_INTERVAL:-10s}
      timeout: ${HEALTHCHECK_TIMEOUT:-5s}
      retries: ${HEALTHCHECK_RETRIES:-5}
      start_period: 10s

# =========================================================
# VOLÚMENES
# =========================================================
volumes:
  postgres_primary_data:
    driver: local
  postgres_replica_data:
    driver: local

# =========================================================
# REDES
# =========================================================
networks:
  research_network:
    name: ${NETWORK_NAME:-research_network}
    driver: bridge
